{% extends "base.html" %}

{% block title %}Proponi Modifiche - {{ project.name }}{% endblock %}

{% block content %}
<main class="bg-black min-h-screen text-white py-8 md:py-12">
    <div class="max-w-5xl mx-auto px-6">
        
        {# Breadcrumb #}
        <nav aria-label="Breadcrumb" class="mb-8">
            <ol class="flex items-center gap-2 text-sm text-gray-500">
                <li><a class="hover:text-white transition-colors" href="{{ url_for('projects.home') }}">Home</a></li>
                <li><span>/</span></li>
                <li><a class="hover:text-white transition-colors" href="{{ url_for('projects.project_detail', project_id=project.id) }}">{{ project.name }}</a></li>
                <li><span>/</span></li>
                <li><span class="text-gray-400">Proponi Modifiche</span></li>
            </ol>
        </nav>

        {# Header #}
        <div class="mb-8 md:mb-12">
            <h1 class="text-5xl md:text-7xl font-bold font-display mb-4">Proponi Modifiche</h1>
            <p class="text-xl text-gray-500 mb-6">
                Condividi un contributo per <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="text-white hover:text-accent transition-colors">{{ project.name }}</a>
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                    <div class="text-sm text-gray-500 mb-1">Equity Disponibile</div>
                    <div class="text-2xl font-bold text-white font-display">{{ "%.2f"|format(available_equity) }}%</div>
                </div>
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
                    <div class="text-sm text-gray-500 mb-1">Come Funziona</div>
                    <div class="text-sm text-gray-400">Aggrega task esistenti o proponi una nuova iniziativa</div>
                </div>
            </div>
        </div>

        {# Form #}
        <div class="bg-gray-900 border border-gray-800 rounded-2xl p-8 md:p-10">
            <form method="POST" id="proposalForm" action="{{ url_for('free_proposals.propose_free_solution', project_id=project.id) }}" enctype="multipart/form-data" onsubmit="return validateProposalForm(event)">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                {# Step 1: Tipo Proposta #}
                <section class="mb-10 pb-10 border-b border-gray-800">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">1</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Tipo di Proposta</h2>
                            <p class="text-gray-500 text-sm mt-1">Scegli se aggregare task esistenti o proporre un nuovo task</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="proposal_type" value="multi_task" checked onchange="switchProposalType('multi_task')" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-6 hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <div class="flex items-start justify-between mb-3">
                                    <h3 class="text-lg font-bold text-white">Aggrega Task Esistenti</h3>
                                    <span class="material-icons text-accent peer-checked:block hidden">check_circle</span>
                                </div>
                                <p class="text-sm text-gray-500">Seleziona più task correlati e presentali con un'unica soluzione coordinata</p>
                            </div>
                        </label>

                        <label class="relative cursor-pointer">
                            <input type="radio" name="proposal_type" value="new_task" onchange="switchProposalType('new_task')" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-6 hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <div class="flex items-start justify-between mb-3">
                                    <h3 class="text-lg font-bold text-white">Proponi Nuovo Task</h3>
                                    <span class="material-icons text-accent peer-checked:block hidden">check_circle</span>
                                </div>
                                <p class="text-sm text-gray-500">Suggerisci un'attività che manca e spiegane l'impatto per il progetto</p>
                            </div>
                        </label>
                    </div>
                </section>

                {# Step 2: Multi-Task Section #}
                <section id="multi-task-section" class="mb-10 pb-10 border-b border-gray-800">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">2</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Seleziona i Task</h2>
                            <p class="text-gray-500 text-sm mt-1">Scegli i task che vuoi risolvere insieme</p>
                        </div>
                    </div>

                    {% if available_tasks %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        {% for task in available_tasks %}
                        <label class="relative cursor-pointer">
                            <input type="checkbox" name="task_ids" value="{{ task.id }}" id="task_{{ task.id }}" data-equity="{{ task.equity_reward }}" onchange="updateTaskSummary()" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-5 hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <div class="flex items-start justify-between mb-3">
                                    <h3 class="text-base font-bold text-white flex-1">{{ task.title }}</h3>
                                    <span class="px-3 py-1 bg-blue-900/30 border border-blue-800 rounded-full text-xs font-bold text-blue-400 ml-2">{{ task.equity_reward }}%</span>
                                </div>
                                <p class="text-sm text-gray-500 line-clamp-2">
                                    {{ task.description[:140] }}{% if task.description|length > 140 %}...{% endif %}
                                </p>
                            </div>
                        </label>
                        {% endfor %}
                    </div>

                    <div id="task-summary" class="hidden bg-gray-800 border border-gray-700 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-400"><strong id="selected-count" class="text-white">0</strong> task selezionati</span>
                            <span class="text-gray-400">Equity totale: <strong id="total-equity" class="text-accent">0.00</strong>%</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 text-center">
                        <p class="text-gray-500">Al momento non ci sono task disponibili da aggregare.</p>
                    </div>
                    {% endif %}
                </section>

                {# Step 2: New Task Section #}
                <section id="new-task-section" class="mb-10 pb-10 border-b border-gray-800 hidden">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">2</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Descrivi il Nuovo Task</h2>
                            <p class="text-gray-500 text-sm mt-1">Racconta cosa realizzerai e perché è utile al progetto</p>
                        </div>
                    </div>

                    <div>
                        <label for="new_task_details" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                            Dettagli del Task Proposto <span class="text-accent">*</span>
                        </label>
                        <textarea id="new_task_details" name="new_task_details" rows="6" 
                                  class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors"
                                  placeholder="Descrivi la proposta, gli obiettivi, le milestone e il valore per il progetto..."></textarea>
                        <p class="text-xs text-gray-500 mt-2">Minimo 50 caratteri. Suggerisci deliverable concreti e spiegane l'impatto.</p>
                    </div>
                </section>

                {# Step 3: Tipo Contenuto #}
                <section class="mb-10 pb-10 border-b border-gray-800">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">3</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Tipo di Contenuto</h2>
                            <p class="text-gray-500 text-sm mt-1">Scegli il tipo di contributo che vuoi proporre</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="software" checked onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">code</span>
                                <div class="text-xs font-bold text-white">Software</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="design" onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">palette</span>
                                <div class="text-xs font-bold text-white">Design</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="hardware" onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">memory</span>
                                <div class="text-xs font-bold text-white">Hardware</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="documentation" onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">description</span>
                                <div class="text-xs font-bold text-white">Doc</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="media" onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">videocam</span>
                                <div class="text-xs font-bold text-white">Media</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="content_type" value="mixed" onclick="selectContentType(this)" class="peer sr-only">
                            <div class="bg-black border-2 border-gray-800 rounded-xl p-4 text-center hover:border-accent transition-all peer-checked:border-accent peer-checked:bg-gray-800">
                                <span class="material-icons text-3xl text-gray-600 peer-checked:text-accent mb-2 block">apps</span>
                                <div class="text-xs font-bold text-white">Misto</div>
                            </div>
                        </label>
                    </div>

                    {# Tabs Upload/Codice/PR #}
                    <div class="flex gap-2 mb-4 border-b border-gray-800">
                        <button type="button" class="px-4 py-2 border-b-2 border-white text-white font-bold transition-colors content-tab active" data-tab="files" onclick="toggleContentTab(event, 'files')">
                            Carica File
                        </button>
                        <button type="button" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-white font-bold transition-colors content-tab" data-tab="code" onclick="toggleContentTab(event, 'code')">
                            Incolla Codice
                        </button>
                        <button type="button" class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-white font-bold transition-colors content-tab" data-tab="pr" onclick="toggleContentTab(event, 'pr')">
                            Link PR
                        </button>
                    </div>

                    {# Tab Files #}
                    <div id="fpc-tab-files" class="content-tab-panel">
                        <div id="fpcDropzone" onclick="triggerProposalFileInput()" ondragover="handleProposalDrag(event)" ondragleave="handleProposalDragLeave(event)" ondrop="handleProposalDrop(event)" 
                             class="border-2 border-dashed border-gray-700 rounded-xl p-12 text-center cursor-pointer hover:border-accent transition-colors bg-gray-800">
                            <span class="material-icons text-5xl text-gray-600 mb-3 block">cloud_upload</span>
                            <p class="text-white font-bold mb-1">Trascina qui i tuoi file</p>
                            <p class="text-sm text-gray-500">oppure clicca per selezionarli</p>
                        </div>
                        <input type="file" name="files" id="fpcFileInput" class="hidden" multiple onchange="handleProposalFiles(this.files)">
                        <div id="fpcFileList" class="mt-4 space-y-2"></div>
                        <p class="text-xs text-gray-500 mt-3">Max 100MB per file. Formati: zip, immagini, documenti, file CAD</p>
                    </div>

                    {# Tab Code #}
                    <div id="fpc-tab-code" class="content-tab-panel hidden">
                        <label for="fpcCodeTextarea" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                            Incolla il Codice <span class="text-accent">*</span>
                        </label>
                        <textarea id="fpcCodeTextarea" name="solution_code_auto" rows="12" 
                                  class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors font-mono text-sm"
                                  placeholder="// Incolla qui il codice sorgente o lo snippet principale del tuo contributo"></textarea>
                        <div id="fpcCodeCounter" class="text-xs text-gray-500 mt-2">0 caratteri</div>
                        <p class="text-xs text-gray-500 mt-2">Se il progetto ha un repository GitHub, genereremo automaticamente fork, branch e Pull Request</p>
                    </div>

                    {# Tab PR #}
                    <div id="fpc-tab-pr" class="content-tab-panel hidden">
                        <label for="fpcPrInput" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                            URL Pull Request GitHub
                        </label>
                        <input type="url" id="fpcPrInput" name="pull_request_url" 
                               class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors"
                               placeholder="https://github.com/owner/repo/pull/123">
                        <p class="text-xs text-gray-500 mt-2">Se hai già creato manualmente una PR, inserisci qui il link</p>
                    </div>

                    {# Note Tecniche #}
                    <div class="mt-6">
                        <label for="solution_content" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                            Note Tecniche Aggiuntive <span class="text-gray-500 normal-case">(Opzionale)</span>
                        </label>
                        <textarea id="solution_content" name="solution_content" rows="5" 
                                  class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors"
                                  placeholder="Dettaglia come vanno usati i file allegati, eventuali dipendenze o istruzioni di setup"></textarea>
                    </div>
                </section>

                {# Step 4: Titolo e Descrizione #}
                <section class="mb-10 pb-10 border-b border-gray-800">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">4</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Presenta la Proposta</h2>
                            <p class="text-gray-500 text-sm mt-1">Definisci un titolo chiaro e una descrizione completa</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label for="title" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                                Titolo della Proposta <span class="text-accent">*</span>
                            </label>
                            <input type="text" id="title" name="title" required minlength="5" maxlength="200" 
                                   class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors"
                                   placeholder="Es: Refactoring completo API con copertura test">
                            <p class="text-xs text-gray-500 mt-2">Un titolo conciso che descriva bene cosa farai (5-200 caratteri)</p>
                        </div>

                        <div>
                            <label for="description" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                                Descrizione Dettagliata <span class="text-accent">*</span>
                            </label>
                            <textarea id="description" name="description" rows="8" required minlength="50" oninput="updateCharCount()" 
                                      class="w-full bg-black border border-gray-800 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-accent focus:ring-1 focus:ring-accent transition-colors"
                                      placeholder="Spiega come affronterai l'attività, quali tecnologie userai e quali risultati garantirai"></textarea>
                            <p class="text-xs text-gray-500 mt-2">
                                <span id="desc-char-count" class="font-bold">0</span><span class="text-gray-500">/ 50 caratteri minimi</span>
                            </p>
                        </div>
                    </div>
                </section>

                {# Step 5: Equity #}
                <section class="mb-10">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xl">5</div>
                        <div>
                            <h2 class="text-2xl font-bold font-display text-white">Equity Richiesta</h2>
                            <p class="text-gray-500 text-sm mt-1">Richiedi una quota proporzionata al valore della proposta (max {{ "%.2f"|format(available_equity) }}%)</p>
                        </div>
                    </div>

                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                        <label for="equity_requested" class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-wider">
                            Equity Desiderata <span class="text-accent">*</span>
                        </label>
                        <div class="flex items-center gap-3">
                            <input type="number" id="equity_requested" name="equity_requested" min="0.1" max="{{ available_equity }}" step="0.1" required value="5.0" oninput="updateEquityPreview()" 
                                   class="w-32 bg-black border border-gray-800 rounded-lg px-4 py-3 text-white focus:border-accent focus:ring-1 focus:ring-accent transition-colors">
                            <span class="text-gray-400 font-bold">%</span>
                            <div class="flex-1 bg-gray-900 border border-gray-800 rounded-lg p-4">
                                <div class="text-xs text-gray-500 mb-1">Con questa richiesta otterresti:</div>
                                <div id="equity-value" class="text-2xl font-bold text-accent font-display">5.0%</div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Valore compreso tra 0.1% e {{ "%.2f"|format(available_equity) }}%</p>
                    </div>
                </section>

                {# Actions #}
                <div class="pt-6 border-t border-gray-800 flex flex-col sm:flex-row justify-end gap-3">
                    <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" 
                       class="px-6 py-3 bg-gray-800 border border-gray-700 text-white rounded-lg hover:bg-gray-700 transition-colors text-center font-medium">
                        Annulla
                    </a>
                    <button type="submit" id="submit-btn" 
                            class="px-6 py-3 bg-accent text-white rounded-lg hover:bg-red-600 transition-colors font-bold flex items-center justify-center gap-2">
                        <span class="material-icons text-sm">rocket_launch</span>
                        Invia Proposta
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script>
let proposalUploadedFiles = [];
const PROPOSAL_MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB

function selectContentType(radio) {
    document.querySelectorAll('input[name="content_type"]').forEach(r => {
        const card = r.closest('label').querySelector('div');
        if (card) {
            card.classList.remove('border-accent', 'bg-gray-800');
            const icon = card.querySelector('.material-icons');
            if (icon) icon.classList.remove('text-accent');
        }
    });
    const card = radio.closest('label').querySelector('div');
    if (card) {
        card.classList.add('border-accent', 'bg-gray-800');
        const icon = card.querySelector('.material-icons');
        if (icon) icon.classList.add('text-accent');
    }
    radio.checked = true;
}

function toggleContentTab(event, tab) {
    if (event) event.preventDefault();
    
    document.querySelectorAll('.content-tab').forEach(btn => {
        btn.classList.remove('border-white', 'text-white');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    if (event?.currentTarget) {
        event.currentTarget.classList.add('border-white', 'text-white');
        event.currentTarget.classList.remove('border-transparent', 'text-gray-500');
    }
    
    document.querySelectorAll('.content-tab-panel').forEach(panel => panel.classList.add('hidden'));
    const target = document.getElementById(`fpc-tab-${tab}`);
    if (target) target.classList.remove('hidden');
}

function triggerProposalFileInput() {
    document.getElementById('fpcFileInput')?.click();
}

function handleProposalDrag(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropzone = document.getElementById('fpcDropzone');
    if (dropzone) dropzone.classList.add('border-accent', 'bg-gray-700');
}

function handleProposalDragLeave(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropzone = document.getElementById('fpcDropzone');
    if (dropzone && (event.target === dropzone || event.relatedTarget === null)) {
        dropzone.classList.remove('border-accent', 'bg-gray-700');
    }
}

function handleProposalDrop(event) {
    event.preventDefault();
    event.stopPropagation();
    const dropzone = document.getElementById('fpcDropzone');
    if (dropzone) dropzone.classList.remove('border-accent', 'bg-gray-700');
    
    if (event.dataTransfer?.files?.length) {
        handleProposalFiles(event.dataTransfer.files);
    }
}

function handleProposalFiles(fileList) {
    if (!fileList || !fileList.length) return;
    
    const warnings = [];
    Array.from(fileList).forEach(file => {
        if (file.size > PROPOSAL_MAX_FILE_SIZE) {
            warnings.push(`"${file.name}" supera il limite di 100MB e verrà ignorato.`);
            return;
        }
        
        const duplicate = proposalUploadedFiles.some(existing => 
            existing.name === file.name && existing.size === file.size && existing.lastModified === file.lastModified
        );
        
        if (!duplicate) {
            proposalUploadedFiles.push(file);
        }
    });
    
    syncProposalFileInput();
    renderProposalFiles();
    
    if (warnings.length) {
        alert(warnings.join('\n'));
    }
}

function syncProposalFileInput() {
    const input = document.getElementById('fpcFileInput');
    if (!input) return;
    
    const dataTransfer = new DataTransfer();
    proposalUploadedFiles.forEach(file => dataTransfer.items.add(file));
    input.files = dataTransfer.files;
}

function renderProposalFiles() {
    const container = document.getElementById('fpcFileList');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (proposalUploadedFiles.length === 0) {
        container.innerHTML = '<div class="text-gray-500 text-sm">Nessun file selezionato</div>';
        return;
    }
    
    proposalUploadedFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center justify-between bg-gray-800 border border-gray-700 rounded-lg p-3';
        item.innerHTML = `
            <div class="flex-1">
                <div class="text-sm font-bold text-white">${escapeHtml(file.name)}</div>
                <div class="text-xs text-gray-500">${formatFileSize(file.size)}</div>
            </div>
            <button type="button" onclick="removeProposalFile(${index})" class="text-red-400 hover:text-red-300 transition-colors">
                <span class="material-icons text-sm">close</span>
            </button>
        `;
        container.appendChild(item);
    });
}

function removeProposalFile(index) {
    proposalUploadedFiles.splice(index, 1);
    syncProposalFileInput();
    renderProposalFiles();
}

function formatFileSize(bytes) {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    if (bytes < 1024 * 1024 * 1024) return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    return `${(bytes / (1024 * 1024 * 1024)).toFixed(1)} GB`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function updateProposalCodeCounter() {
    const textarea = document.getElementById('fpcCodeTextarea');
    const counter = document.getElementById('fpcCodeCounter');
    if (!textarea || !counter) return;
    const count = textarea.value.length;
    counter.textContent = `${count.toLocaleString()} caratteri`;
}

function switchProposalType(type) {
    const multiSection = document.getElementById('multi-task-section');
    const newSection = document.getElementById('new-task-section');
    const summary = document.getElementById('task-summary');
    
    if (type === 'multi_task') {
        if (multiSection) multiSection.classList.remove('hidden');
        if (newSection) newSection.classList.add('hidden');
    } else if (type === 'new_task') {
        if (multiSection) multiSection.classList.add('hidden');
        if (newSection) newSection.classList.remove('hidden');
        if (summary) summary.classList.add('hidden');
    }
}

function updateTaskSummary() {
    const allCheckboxes = document.querySelectorAll('input[name="task_ids"]');
    const checkedCheckboxes = document.querySelectorAll('input[name="task_ids"]:checked');
    const count = checkedCheckboxes.length;
    const summary = document.getElementById('task-summary');
    const selectedCount = document.getElementById('selected-count');
    const totalEquity = document.getElementById('total-equity');
    const equityInput = document.getElementById('equity_requested');
    const equityValue = document.getElementById('equity-value');
    
    let total = 0;
    checkedCheckboxes.forEach(cb => {
        total += parseFloat(cb.dataset.equity || 0);
    });
    
    allCheckboxes.forEach(cb => {
        const card = cb.closest('label').querySelector('div');
        if (card) {
            card.classList.toggle('border-accent', cb.checked);
            card.classList.toggle('bg-gray-800', cb.checked);
        }
    });
    
    if (count > 0 && summary) {
        summary.classList.remove('hidden');
        if (selectedCount) selectedCount.textContent = count;
        if (totalEquity) totalEquity.textContent = total.toFixed(2);
        
        const multiTaskRadio = document.getElementById('multi_task');
        if (multiTaskRadio && multiTaskRadio.checked && equityInput) {
            equityInput.value = total.toFixed(1);
            if (equityValue) equityValue.textContent = total.toFixed(1) + '%';
        }
    } else if (summary) {
        summary.classList.add('hidden');
    }
}

function updateEquityPreview() {
    const equityInput = document.getElementById('equity_requested');
    const equityValue = document.getElementById('equity-value');
    if (equityInput && equityValue) {
        equityValue.textContent = equityInput.value + '%';
    }
}

function updateCharCount() {
    const textarea = document.getElementById('description');
    const charCount = document.getElementById('desc-char-count');
    if (textarea && charCount) {
        const count = textarea.value.length;
        charCount.textContent = count;
        charCount.classList.toggle('text-red-500', count < 50);
        charCount.classList.toggle('text-white', count >= 50);
    }
}

function validateProposalForm(event) {
    const title = document.getElementById('title');
    const description = document.getElementById('description');
    const equity = document.getElementById('equity_requested');
    const proposalType = document.querySelector('input[name="proposal_type"]:checked');
    const codeValue = document.getElementById('fpcCodeTextarea')?.value.trim() || '';
    const prValue = document.getElementById('fpcPrInput')?.value.trim() || '';
    
    if (!title || !title.value.trim()) {
        event.preventDefault();
        alert('⚠️ Il titolo è obbligatorio');
        title?.focus();
        return false;
    }
    
    if (!description || description.value.length < 50) {
        event.preventDefault();
        alert('⚠️ La descrizione deve essere di almeno 50 caratteri');
        description?.focus();
        return false;
    }
    
    if (!equity || equity.value <= 0) {
        event.preventDefault();
        alert('⚠️ Devi specificare l\'equity richiesta');
        equity?.focus();
        return false;
    }
    
    if (proposalType && proposalType.value === 'multi_task') {
        const checked = document.querySelectorAll('input[name="task_ids"]:checked');
        if (checked.length === 0) {
            event.preventDefault();
            alert('⚠️ Seleziona almeno un task da aggregare');
            return false;
        }
    } else {
        const newTaskDetails = document.getElementById('new_task_details');
        if (newTaskDetails && newTaskDetails.value.trim().length < 50) {
            event.preventDefault();
            alert('⚠️ La descrizione del nuovo task deve essere di almeno 50 caratteri');
            newTaskDetails.focus();
            return false;
        }
    }
    
    const hasFileUploads = proposalUploadedFiles.length > 0;
    if (!hasFileUploads && !codeValue && !prValue) {
        event.preventDefault();
        alert('⚠️ Carica almeno un file, incolla del codice oppure fornisci un link alla Pull Request.');
        return false;
    }
    
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="material-icons text-sm animate-spin">hourglass_empty</span> Invio in corso...';
    }
    
    return true;
}

document.addEventListener('DOMContentLoaded', () => {
    renderProposalFiles();
    updateEquityPreview();
    updateCharCount();
    updateProposalCodeCounter();
    
    const codeTextarea = document.getElementById('fpcCodeTextarea');
    if (codeTextarea) {
        codeTextarea.addEventListener('input', updateProposalCodeCounter);
    }
    
    // Inizializza radio buttons checked state
    document.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
        if (radio.name === 'content_type') {
            selectContentType(radio);
        }
    });
});
</script>
{% endblock %}
