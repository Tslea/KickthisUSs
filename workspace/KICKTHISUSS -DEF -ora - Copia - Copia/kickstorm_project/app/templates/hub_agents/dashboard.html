{% extends "base.html" %}

{% block title %}Hub Agents - AI Workspace{% endblock %}

{% block head_extra %}
<!-- Monaco Editor Loader -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs/loader.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
    /* --- IDE THEME (Cursor/VS Code Inspired) --- */
    :root {
        --ide-bg: #0d1117;
        /* GitHub Dark Dimmed Background */
        --ide-panel: #161b22;
        /* Panel Background */
        --ide-border: #30363d;
        /* Border Color */
        --ide-text: #c9d1d9;
        /* Primary Text */
        --ide-text-muted: #8b949e;
        /* Secondary Text */
        --ide-accent: #58a6ff;
        /* Blue Accent */
        --ide-success: #238636;
        /* Green Success */
        --ide-hover: #21262d;
        /* Hover State */
    }

    /* Override Base Styles for this page only */
    body {
        background-color: var(--ide-bg) !important;
        color: var(--ide-text);
        overflow-y: hidden;
        /* Prevent body scroll, handle in IDE */
    }

    /* Hide standard footer if present to maximize space */
    footer {
        display: none !important;
    }

    .ide-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 70px);
        /* Adjust based on navbar height */
        background-color: var(--ide-bg);
        font-family: 'Inter', sans-serif;
    }

    /* --- TOP BAR --- */
    .ide-header {
        height: 50px;
        background-color: var(--ide-panel);
        border-bottom: 1px solid var(--ide-border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
    }

    .ide-title {
        font-family: 'JetBrains Mono', monospace;
        font-weight: 700;
        color: var(--ide-text);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ide-badge {
        background: rgba(88, 166, 255, 0.15);
        color: var(--ide-accent);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        border: 1px solid rgba(88, 166, 255, 0.3);
    }

    /* --- MAIN LAYOUT --- */
    .ide-main {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    /* --- LEFT SIDEBAR (EXPLORER) --- */
    .ide-sidebar {
        width: 260px;
        background-color: var(--ide-panel);
        border-right: 1px solid var(--ide-border);
        display: flex;
        flex-direction: column;
    }

    .sidebar-header {
        padding: 10px 15px;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--ide-text-muted);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-actions {
        display: flex;
        gap: 8px;
    }

    .sidebar-btn {
        background: transparent;
        border: none;
        color: white !important;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .sidebar-btn:hover {
        color: white !important;
        background-color: var(--ide-hover);
    }

    .sidebar-btn i {
        pointer-events: none;
    }
    
    /* ‚≠ê NEW FILE BUTTON - More Visible */
    .sidebar-btn-new-file {
        background: linear-gradient(135deg, #238636 0%, #2ea043 100%) !important;
        border: 1px solid #3fb950 !important;
        color: white !important;
        padding: 6px 12px !important;
        border-radius: 6px;
        font-weight: 600;
        font-size: 12px;
        gap: 6px;
        box-shadow: 0 2px 8px rgba(35, 134, 54, 0.3);
        transition: all 0.2s ease;
    }
    
    .sidebar-btn-new-file:hover {
        background: linear-gradient(135deg, #2ea043 0%, #3fb950 100%) !important;
        box-shadow: 0 4px 12px rgba(35, 134, 54, 0.5);
        transform: translateY(-1px);
    }
    
    .sidebar-btn-new-file i {
        font-size: 10px;
    }

    .file-tree {
        flex: 1;
        overflow-y: auto;
        padding: 5px 0;
    }

    .folder-label {
        padding: 8px 15px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--ide-text);
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 10px;
    }

    .folder-label:first-child {
        margin-top: 0;
    }

    .folder-label i {
        color: var(--ide-accent);
    }

    .file-item {
        padding: 6px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        /* Ensure space between name and trash */
        gap: 8px;
        color: var(--ide-text);
        font-size: 0.9rem;
        border-left: 2px solid transparent;
        transition: all 0.2s;
    }

    .file-item:hover {
        background-color: var(--ide-hover);
    }

    .file-item.active {
        background-color: rgba(88, 166, 255, 0.1);
        border-left-color: var(--ide-accent);
        color: var(--ide-accent);
    }

    .file-item i {
        color: var(--ide-text-muted);
        font-size: 1rem;
    }

    .file-item.active i {
        color: var(--ide-accent);
    }

    /* --- CENTER (EDITOR) --- */
    .ide-editor-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: var(--ide-bg);
        position: relative;
    }

    .editor-tabs {
        height: 35px;
        background-color: var(--ide-bg);
        display: flex;
        align-items: center;
        border-bottom: 1px solid var(--ide-border);
    }

    .tab {
        padding: 0 15px;
        height: 100%;
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--ide-panel);
        border-right: 1px solid var(--ide-border);
        border-top: 2px solid var(--ide-accent);
        color: var(--ide-text);
        font-size: 0.85rem;
        cursor: pointer;
    }

    .editor-toolbar {
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--ide-bg);
        border-bottom: 1px solid var(--ide-border);
    }

    .btn-ide {
        background: transparent;
        border: 1px solid var(--ide-border);
        color: var(--ide-text);
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-ide:hover {
        background-color: var(--ide-hover);
        border-color: var(--ide-text-muted);
        color: white;
    }

    .btn-ide-primary {
        background-color: var(--ide-success);
        border-color: var(--ide-success);
        color: white;
    }

    .btn-ide-primary:hover {
        background-color: #2ea043;
    }

    .btn-ide-magic {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        border: none;
        color: white;
        box-shadow: 0 2px 10px rgba(168, 85, 247, 0.3);
    }

    .btn-ide-magic:hover {
        box-shadow: 0 4px 15px rgba(168, 85, 247, 0.5);
        transform: translateY(-1px);
    }

    /* --- RIGHT SIDEBAR (AI CHAT) --- */
    .ide-chat-panel {
        width: 350px;
        background-color: var(--ide-panel);
        border-left: 1px solid var(--ide-border);
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid var(--ide-border);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .chat-msg {
        font-size: 0.9rem;
        line-height: 1.5;
        max-width: 90%;
    }

    .chat-msg.ai {
        align-self: flex-start;
        color: var(--ide-text);
    }

    .chat-msg.user {
        align-self: flex-end;
        background-color: var(--ide-accent);
        color: white;
        padding: 8px 12px;
        border-radius: 12px 12px 0 12px;
    }

    .chat-input-area {
        padding: 15px;
        border-top: 1px solid var(--ide-border);
        background-color: var(--ide-panel);
    }

    .chat-input-wrapper {
        background-color: var(--ide-bg);
        border: 1px solid var(--ide-border);
        border-radius: 8px;
        padding: 8px;
        display: flex;
        align-items: flex-end;
        gap: 8px;
    }

    .chat-input-wrapper:focus-within {
        border-color: var(--ide-accent);
        box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }

    .chat-input {
        background: transparent;
        border: none;
        color: var(--ide-text);
        width: 100%;
        resize: none;
        max-height: 100px;
        font-family: 'Inter', sans-serif;
        font-size: 0.9rem;
    }

    .chat-input:focus {
        outline: none;
    }

    .btn-send {
        background: var(--ide-accent);
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--ide-bg);
    }

    ::-webkit-scrollbar-thumb {
        background: var(--ide-border);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--ide-text-muted);
    }

    /* Activation Screen Override */
    .activation-card {
        background-color: var(--ide-panel);
        border: 1px solid var(--ide-border);
        color: var(--ide-text);
    }

    /* --- MODAL INPUT --- */
    .input-modal {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--ide-panel);
        border: 1px solid var(--ide-accent);
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        width: 400px;
    }

    .input-modal h4 {
        margin-bottom: 10px;
        font-size: 0.9rem;
        font-weight: bold;
        color: var(--ide-text);
    }

    .input-modal input,
    .input-modal select {
        width: 100%;
        background: var(--ide-bg);
        border: 1px solid var(--ide-border);
        color: var(--ide-text);
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    .input-modal input:focus {
        border-color: var(--ide-accent);
        outline: none;
    }

    .input-modal .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="ide-wrapper">
    <!-- HEADER -->
    <div class="ide-header">
        <div class="ide-title">
            <i class="fas fa-robot text-purple-400"></i>
            <span>HUB AGENTS</span>
            <span class="ide-badge">AI POWERED</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-xs text-gray-500 font-mono">Project ID: {{ project_id }}</span>
            <a href="{{ url_for('hub_agents.export_pitch_deck', project_id=project_id) }}" class="btn-ide btn-ide-magic"
                title="Download PDF Pitch Deck">
                <i class="fas fa-file-pdf"></i> Export Deck
            </a>
            <button onclick="syncStructure()" class="btn-ide" title="Restore missing files">
                <i class="fas fa-sync-alt"></i> Sync
            </button>
            <a href="{{ url_for('projects.project_detail', project_id=project_id) }}" class="btn-ide">
                <i class="fas fa-sign-out-alt"></i> Exit
            </a>
        </div>
    </div>

    {% if not hub_project %}
    <!-- ACTIVATION SCREEN (Dark Mode) -->
    <div class="flex items-center justify-center h-full">
        <div class="activation-card p-8 rounded-xl shadow-2xl max-w-2xl text-center">
            <div class="mb-6">
                <div class="w-20 h-20 bg-purple-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-brain text-4xl text-purple-400"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Initialize AI Workspace</h2>
                <p class="text-gray-400">
                    Transform your project management with AI-driven documentation, strategy, and analysis.
                </p>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-8 text-left">
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <i class="fas fa-folder-tree text-blue-400 mb-2"></i>
                    <h4 class="font-bold text-sm">Smart Structure</h4>
                    <p class="text-xs text-gray-500">Auto-generated folder hierarchy for startups.</p>
                </div>
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <i class="fas fa-magic text-purple-400 mb-2"></i>
                    <h4 class="font-bold text-sm">AI Auto-Fill</h4>
                    <p class="text-xs text-gray-500">Generate content for any document instantly.</p>
                </div>
                <div class="p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <i class="fas fa-search text-green-400 mb-2"></i>
                    <h4 class="font-bold text-sm">RAG Context</h4>
                    <p class="text-xs text-gray-500">Chat with full project context awareness.</p>
                </div>
            </div>

            <button id="activateBtn" class="btn-ide btn-ide-magic px-8 py-3 text-lg w-full justify-center">
                <i class="fas fa-power-off"></i> Activate Hub Agents
            </button>
        </div>
    </div>

    <script>
        document.getElementById('activateBtn').addEventListener('click', function () {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing...';

            fetch('{{ url_for("hub_agents.activate_ai_hub", project_id=project_id) }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' }
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') location.reload();
                    else { alert(d.message); btn.disabled = false; btn.innerHTML = 'Retry'; }
                });
        });
    </script>

    {% else %}
    <!-- IDE MAIN INTERFACE -->
    <div class="ide-main">
        <!-- LEFT: FILE EXPLORER -->
        <div class="ide-sidebar">
            <div class="sidebar-header">
                <span><i class="fas fa-project-diagram mr-2"></i> EXPLORER</span>
                <div class="sidebar-actions">
                    <button class="sidebar-btn sidebar-btn-new-file" title="Create New Document" onclick="showNewFileModal()">
                        <i class="fas fa-plus"></i> <span>New</span>
                    </button>
                    <button class="sidebar-btn" title="Refresh" onclick="refreshFileTree()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="file-tree" id="fileTree">
                <!-- Dynamic Content -->
                <div class="text-center text-gray-500 mt-4 text-xs">Loading structure...</div>
            </div>
        </div>

        <!-- CENTER: EDITOR -->
        <div class="ide-editor-area">
            <div class="editor-tabs">
                <div class="tab">
                    <i class="fas fa-file-alt text-blue-400"></i>
                    <span id="currentDocName">mvp_definition.md</span>
                    <i class="fas fa-times text-gray-500 hover:text-white ml-2 text-xs"></i>
                </div>
            </div>

            <div class="editor-toolbar">
                <div class="text-xs text-gray-500">
                    Markdown ‚Ä¢ UTF-8
                </div>
                <div class="flex gap-2">
                    <button class="btn-ide btn-ide-magic" id="autoFillBtn">
                        <i class="fas fa-sparkles"></i> AI Auto-Fill
                    </button>
                    <button class="btn-ide btn-ide-primary" id="saveBtn">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>

            <div id="monaco-editor-container" style="width: 100%; height: 100%;"></div>

            <!-- NEW FILE MODAL -->
            <div id="newFileModal" class="input-modal">
                <h4>Create New Document</h4>
                <input type="text" id="newFileName" placeholder="filename.md">
                <select id="newFileCategory">
                    <option value="00_IDEA_VALIDATION">00_IDEA_VALIDATION</option>
                    <option value="01_MARKET_RESEARCH">01_MARKET_RESEARCH</option>
                    <option value="02_BUSINESS_MODEL">02_BUSINESS_MODEL</option>
                    <option value="03_PRODUCT_STRATEGY">03_PRODUCT_STRATEGY</option>
                    <option value="04_GO_TO_MARKET">04_GO_TO_MARKET</option>
                    <option value="99_OTHER">99_OTHER</option>
                </select>
                <div class="modal-actions">
                    <button class="btn-ide" onclick="hideNewFileModal()">Cancel</button>
                    <button class="btn-ide btn-ide-primary" onclick="createNewFile()">Create</button>
                </div>
            </div>
        </div>

        <!-- RIGHT: AI CHAT -->
        <div class="ide-chat-panel">
            <div class="chat-header">
                <div class="w-2 h-2 rounded-full bg-green-500"></div>
                <span class="font-bold text-sm">AI Copilot</span>
                <span class="text-xs text-gray-500 ml-auto">Grok-4-Fast</span>
            </div>

            <div id="chatMessages" class="chat-messages">
                <div class="chat-msg ai">
                    <div class="flex gap-3">
                        <div class="w-6 h-6 rounded bg-purple-900/50 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-xs text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-gray-300">Hello! I'm your Project Copilot.</p>
                            <p class="text-gray-400 text-xs mt-1">I have access to all your project files. Ask me
                                anything about your strategy or MVP.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea id="chatInput" class="chat-input" rows="1"
                        placeholder="Ask about this document..."></textarea>
                    <button id="sendChatBtn" class="btn-send">
                        <i class="fas fa-arrow-up text-xs"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <span class="text-[10px] text-gray-600">AI can make mistakes. Review generated content.</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MONACO EDITOR SETUP ---
        let editor;
        let currentFileCategory = null; // Track current file category

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.36.1/min/vs' } });

        function initEditor(filename) {
            require(['vs/editor/editor.main'], function () {
                // Destroy existing if any
                if (editor) editor.dispose();

                // Load content - include category for precise document matching
                let loadUrl = `{{ url_for("hub_agents.load_document") }}?project_id={{ project_id }}&filename=${encodeURIComponent(filename)}`;
                if (currentFileCategory) {
                    loadUrl += `&category=${encodeURIComponent(currentFileCategory)}`;
                }
                console.log('Loading file from:', loadUrl);

                fetch(loadUrl)
                    .then(response => {
                        console.log('Load response status:', response.status, 'Content-Type:', response.headers.get('content-type'));
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                            }).catch(err => {
                                // Se non riesce a parsare il JSON, significa che ha ricevuto HTML
                                throw new Error(`Server error: ${response.status} ${response.statusText}. Verifica che tu sia loggato.`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('File loaded successfully:', { filename, hasContent: !!data.content, source: data.source });

                        if (data.error) {
                            alert(`Errore durante il caricamento: ${data.error}`);
                            return;
                        }

                        const initialContent = data.content || '# ' + filename + '\n\nStatus: üî¥ Not Started\n\n(Click "AI Auto-Fill" to generate draft...)';

                        editor = monaco.editor.create(document.getElementById('monaco-editor-container'), {
                            value: initialContent,
                            language: 'markdown',
                            theme: 'vs-dark', // We will override colors via CSS mostly, but vs-dark is base
                            automaticLayout: true,
                            minimap: { enabled: false },
                            wordWrap: 'on',
                            fontSize: 14,
                            fontFamily: 'JetBrains Mono',
                            padding: { top: 20, bottom: 20 }
                        });

                        // Update UI
                        document.getElementById('currentDocName').innerText = filename;

                        // Update active state in sidebar
                        document.querySelectorAll('.file-item').forEach(el => {
                            el.classList.remove('active');
                            if (el.innerText.includes(filename)) el.classList.add('active');
                        });
                    })
                    .catch(err => {
                        console.error('Error loading file:', err);
                        alert(`Errore nel caricamento del file: ${err.message}`);
                    });
            });
        }

        // Global function for sidebar clicks
        window.loadFile = function (filename, category) {
            console.log('loadFile called with:', filename, 'category:', category);
            currentFileCategory = category; // Store category
            initEditor(filename);
        };

        // --- FILE TREE LOGIC ---
        function refreshFileTree() {
            const tree = document.getElementById('fileTree');
            console.log('refreshFileTree called, tree element:', tree);
            tree.innerHTML = '<div class="text-center text-gray-500 mt-4 text-xs">Loading...</div>';

            const url = `{{ url_for("hub_agents.get_project_structure", project_id=project_id) }}`;
            console.log('Fetching structure from:', url);

            fetch(url)
                .then(r => {
                    console.log('Response received:', r.status, r.ok);
                    if (!r.ok) throw new Error('API not ready');
                    return r.json();
                })
                .then(data => {
                    console.log('Structure data received:', data);
                    console.log('Number of categories:', Object.keys(data).length);

                    tree.innerHTML = '';
                    if (Object.keys(data).length === 0) {
                        tree.innerHTML = '<div class="text-center text-gray-500 mt-4 text-xs">No files found.</div>';
                        return;
                    }

                    for (const [category, files] of Object.entries(data)) {
                        console.log(`Processing category: ${category}, files:`, files);
                        // Folder Header
                        const folderDiv = document.createElement('div');
                        folderDiv.className = 'folder-label';
                        folderDiv.innerHTML = `<i class="fas fa-folder"></i> ${category}`;
                        tree.appendChild(folderDiv);

                        // Files
                        files.forEach(file => {
                            const fileDiv = document.createElement('div');
                            fileDiv.className = 'file-item group flex justify-between items-center pr-2';
                            // Salva il nome del file come attributo data per un accesso pi√π facile
                            fileDiv.dataset.filename = file.filename;

                            const nameSpan = document.createElement('span');
                            nameSpan.innerHTML = `<i class="fas fa-file-markdown"></i> ${file.filename}`;
                            nameSpan.style.pointerEvents = 'none'; // Importante: permette al click di passare al fileDiv

                            const delBtn = document.createElement('i');
                            delBtn.className = 'fas fa-trash';
                            delBtn.style.color = '#ffffff'; // Changed to white as requested
                            delBtn.style.opacity = '0.6';
                            delBtn.style.cursor = 'pointer';
                            delBtn.style.marginLeft = 'auto'; // Push to right
                            delBtn.title = 'Delete file';

                            delBtn.onmouseover = () => delBtn.style.opacity = '1';
                            delBtn.onmouseout = () => delBtn.style.opacity = '0.6';

                            delBtn.onclick = (e) => {
                                e.stopPropagation(); // Stop propagation IMMEDIATELY
                                console.log('Delete clicked for:', file.filename);
                                deleteFile(file.filename);
                            };

                            fileDiv.appendChild(nameSpan);
                            fileDiv.appendChild(delBtn);

                            fileDiv.onclick = (e) => {
                                console.log('File clicked:', file.filename, 'Target:', e.target, 'Category:', category);
                                // Se il target √® il bottone di cancellazione, esci (anche se stopPropagation dovrebbe averlo gi√† gestito)
                                if (e.target === delBtn || e.target.classList.contains('fa-trash')) {
                                    return;
                                }
                                loadFile(file.filename, category); // Pass category
                            };
                            tree.appendChild(fileDiv);
                        });
                    }

                    // Load first file if editor empty
                    if (!editor && Object.keys(data).length > 0) {
                        const firstCategory = Object.keys(data)[0];
                        const firstFile = data[firstCategory][0];
                        if (firstFile) {
                            console.log('Initial load of first file:', firstFile.filename, 'in category:', firstCategory);
                            loadFile(firstFile.filename, firstCategory);
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    tree.innerHTML = '<div class="text-center text-red-500 mt-4 text-xs">Connection Error. Try restarting server.</div>';
                });
        }

        // Initial Load
        refreshFileTree();

        // --- NEW FILE MODAL LOGIC ---
        function showNewFileModal() {
            document.getElementById('newFileModal').style.display = 'block';
            document.getElementById('newFileName').focus();
        }

        function hideNewFileModal() {
            document.getElementById('newFileModal').style.display = 'none';
        }

        function createNewFile() {
            const filename = document.getElementById('newFileName').value;
            const category = document.getElementById('newFileCategory').value;

            if (!filename) return;

            fetch('{{ url_for("hub_agents.create_document") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    project_id: {{ project_id }},
                filename: filename,
                category: category
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    hideNewFileModal();
                    refreshFileTree();
                    // Optionally load the new file immediately
                    setTimeout(() => loadFile(data.filename), 500);
                } else {
                    alert(data.message);
                }
            });
        }

        // --- AUTO-FILL LOGIC ---
        document.getElementById('autoFillBtn').addEventListener('click', function () {
            const btn = this;
            const docName = document.getElementById('currentDocName').innerText;

            if (!confirm('Generate draft with AI? This will overwrite current content.')) return;

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            fetch('{{ url_for("hub_agents.generate_content") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({ project_id: {{ project_id }}, doc_type: docName })
            })
            .then(r => {
                    if (!r.ok) {
                        return r.json().then(data => {
                            throw new Error(data.error || `HTTP ${r.status}: ${r.statusText}`);
                        });
                    }
                    return r.json();
                })
            .then(data => {
                console.log('Generation response:', { hasContent: !!data.content, contentLength: data.content?.length, hasEditor: !!editor, hasError: !!data.error });

                if (data.error) {
                    alert(`Errore durante la generazione: ${data.error}`);
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }

                if (!data.content || data.content.trim() === "") {
                    alert('Generazione fallita: Nessun contenuto ricevuto. Verifica che il servizio AI sia configurato correttamente.');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }

                if (!editor) {
                    console.warn('Editor not initialized, attempting to initialize...');
                    // Se l'editor non √® inizializzato, prova a inizializzarlo con il documento corrente
                    const currentDoc = document.getElementById('currentDocName').innerText;

                    const initializeAndSetContent = () => {
                        if (editor) {
                            editor.setValue(data.content);
                            console.log('Content set successfully (delayed), length:', data.content.length);
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        } else {
                            // Riprova tra poco
                            setTimeout(initializeAndSetContent, 500);
                        }
                    };

                    if (currentDoc && currentDoc !== 'Select a file') {
                        initEditor(currentDoc);
                        // Aspetta un po' per l'inizializzazione
                        setTimeout(initializeAndSetContent, 500);
                    } else {
                        alert('Errore: Nessun file selezionato. Per favore seleziona un file prima di generare il contenuto.');
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    }
                    return;
                }

                // Editor disponibile, imposta il contenuto
                try {
                    // Monaco Editor potrebbe perdere il riferimento al modello se ricaricato male
                    // Assicuriamoci di avere un modello
                    if (!editor.getModel()) {
                        console.warn("Editor model is null, recreating editor...");
                        initEditor(docName);
                        setTimeout(() => {
                            if (editor) editor.setValue(data.content);
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }, 500);
                        return;
                    }

                    editor.setValue(data.content);
                    console.log('Content set successfully, length:', data.content.length);
                } catch (e) {
                    console.error('Error setting editor value:', e);
                    alert('Errore nell\'impostare il contenuto nell\'editor: ' + e.message);
                }

                btn.disabled = false;
                btn.innerHTML = originalHtml;
            })
            .catch(e => {
                console.error('Generation error:', e);
                alert(`Errore durante la generazione: ${e.message || 'Errore sconosciuto'}`);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        });

        // --- SAVE LOGIC ---
        document.getElementById('saveBtn').addEventListener('click', function () {
            const btn = this;
            const docName = document.getElementById('currentDocName').innerText;
            const content = editor ? editor.getValue() : '';

            if (!currentFileCategory) {
                alert('Error: Category not set. Please reload the file.');
                return;
            }

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            console.log('Saving document:', docName, 'category:', currentFileCategory, 'content length:', content.length);

            fetch('{{ url_for("hub_agents.save_document") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    project_id: {{ project_id }},
                filename: docName,
                category: currentFileCategory,
                content: content 
                })
            })
            .then(r => r.json())
            .then(data => {
                console.log('Save response:', data);
                if (data.status === 'success') {
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                    setTimeout(() => { btn.innerHTML = originalHtml; btn.disabled = false; }, 1500);
                } else {
                    alert('Save Error: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                }
            })
            .catch(err => {
                console.error('Save error:', err);
                alert('Network error while saving: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            });
        });

        // --- CHAT LOGIC ---
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const chatMessages = document.getElementById('chatMessages');
        let chatHistory = [];

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `chat-msg ${role === 'user' ? 'user' : 'ai'}`;

            if (role === 'ai') {
                div.innerHTML = `
                    <div class="flex gap-3">
                        <div class="w-6 h-6 rounded bg-purple-900/50 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-xs text-purple-400"></i>
                        </div>
                        <div class="text-gray-300">${text.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            } else {
                div.innerText = text;
            }

            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const msg = chatInput.value.trim();
            if (!msg) return;

            appendMessage('user', msg);
            chatInput.value = '';

            const contextDoc = editor ? editor.getValue() : '';

            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-msg ai text-xs text-gray-500 ml-9';
            typingDiv.innerText = 'Thinking...';
            chatMessages.appendChild(typingDiv);

            fetch('{{ url_for("hub_agents.chat_message") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    project_id: {{ project_id }},
                message: msg,
                context_doc: contextDoc,
                history: chatHistory
                })
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('typingIndicator').remove();
                appendMessage('ai', data.response);
                chatHistory.push({ role: 'user', content: msg });
                chatHistory.push({ role: 'assistant', content: data.response });
            })
            .catch(e => {
                document.getElementById('typingIndicator').remove();
                appendMessage('ai', 'Connection error.');
            });
        }

        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function deleteFile(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;

            fetch('{{ url_for("hub_agents.delete_document") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    project_id: {{ project_id }},
                filename: filename
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    refreshFileTree();
                    // If deleted file was open, clear editor
                    const currentFile = document.getElementById('currentDocName').innerText;
                    if (currentFile === filename) {
                        if (editor) editor.setValue('');
                        document.getElementById('currentDocName').innerText = 'Select a file';
                    }
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Error deleting file');
            });
        }

        function syncStructure() {
            if (!confirm('Restore missing default files?')) return;

            fetch('{{ url_for("hub_agents.activate_ai_hub", project_id=project_id) }}', {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
            })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    refreshFileTree();
                })
                .catch(err => {
                    console.error(err);
                    alert('Sync failed');
                });
        }
    </script>
    {% endif %}
</div>
{% endblock %}