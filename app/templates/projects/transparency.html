{% extends "base.html" %}

{% block title %}Trasparenza - {{ project.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-2">
                    <span class="material-icons text-blue-600">visibility</span>
                    Dashboard Trasparenza
                </h1>
                <p class="text-gray-600">
                    <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" class="text-mclaren-orange hover:underline">
                        {{ project.name }}
                    </a>
                </p>
                <p class="text-sm text-gray-500 mt-2">
                    Dati pubblici e verificabili per totale trasparenza
                </p>
            </div>
            <div class="flex gap-2">
                <a href="{{ url_for('projects.export_transparency', project_id=project.id, format='json') }}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                    <span class="material-icons text-sm mr-2">download</span>
                    Export JSON
                </a>
                <a href="{{ url_for('projects.export_transparency', project_id=project.id, format='csv') }}" 
                   class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm">
                    <span class="material-icons text-sm mr-2">file_download</span>
                    Export CSV
                </a>
            </div>
        </div>
    </div>

    <!-- Summary Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <!-- Total Shares -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <span class="text-blue-100 font-medium">Shares Totali</span>
                <span class="material-icons text-blue-100">account_balance_wallet</span>
            </div>
            <div class="text-3xl font-bold">{{ "%.0f"|format(transparency_data.shares.total) }}</div>
            <div class="text-sm text-blue-100 mt-2">
                Sistema Shares Attivo
            </div>
        </div>

        <!-- Distributed Shares -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <span class="text-green-100 font-medium">Shares Distribuite</span>
                <span class="material-icons text-green-100">people</span>
            </div>
            <div class="text-3xl font-bold">{{ "%.0f"|format(transparency_data.shares.distributed) }}</div>
            <div class="text-sm text-green-100 mt-2">
                {{ transparency_data.shares.holders_count }} holders
            </div>
        </div>

        <!-- Total Revenue -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <span class="text-purple-100 font-medium">Revenue Totale</span>
                <span class="material-icons text-purple-100">euro</span>
            </div>
            <div class="text-3xl font-bold">€{{ "%.2f"|format(transparency_data.revenue.total) }}</div>
            <div class="text-sm text-purple-100 mt-2">
                {{ transparency_data.revenue.records_count }} record
            </div>
        </div>

        <!-- Total Distributions -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
            <div class="flex items-center justify-between mb-2">
                <span class="text-orange-100 font-medium">Distribuzioni</span>
                <span class="material-icons text-orange-100">payments</span>
            </div>
            <div class="text-3xl font-bold">€{{ "%.2f"|format(transparency_data.distributions.total) }}</div>
            <div class="text-sm text-orange-100 mt-2">
                {{ transparency_data.distributions.count }} distribuzioni
            </div>
        </div>
    </div>

    <!-- Shares Overview -->
    {% if transparency_data.uses_shares_system %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-white">Partecipazione (Shares)</h2>
                    <p class="text-blue-100 text-sm mt-1">Distribuzione shares tra i partecipanti</p>
                </div>
                <div class="text-right text-white">
                    <div class="text-sm text-blue-100">Disponibili</div>
                    <div class="text-2xl font-bold">{{ "%.0f"|format(transparency_data.shares.available) }}</div>
                </div>
            </div>
        </div>

        <div class="p-6">
            {% if transparency_data.shares.holders %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Partecipante</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Shares</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Percentuale</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ottenute da</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for holder in transparency_data.shares.holders %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-gray-500">#{{ loop.index }}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                {% if holder.is_anonymous %}
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 text-sm font-bold mr-2">
                                            ?
                                        </div>
                                        <span class="text-sm font-medium text-gray-700">{{ holder.username }}</span>
                                    </div>
                                {% else %}
                                    <div class="flex items-center">
                                        <div class="h-8 w-8 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white text-sm font-bold mr-2">
                                            {{ holder.username[0].upper() }}
                                        </div>
                                        <div class="flex flex-col">
                                            <a href="{{ url_for('users.user_profile', username=holder.username) }}" 
                                               class="text-sm font-medium text-blue-600 hover:text-blue-800">
                                                {{ holder.username }}
                                            </a>
                                            {% if holder.get('is_creator') %}
                                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 mt-1 w-fit">
                                                <span class="material-icons text-xs mr-1">star</span>
                                                Creatore
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap text-right font-semibold">{{ "%.2f"|format(holder.shares_count) }}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-right">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ "%.2f"|format(holder.percentage) }}%
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500">
                                {% if holder.get('earned_from_display') %}
                                    {{ holder.earned_from_display }}
                                {% else %}
                                    {{ holder.earned_from or 'N/A' }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Tooltip/spiegazione per allocazione iniziale -->
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-xs text-blue-800">
                    <span class="material-icons text-sm align-middle">info</span>
                    <strong>Allocazione iniziale automatica:</strong> Il creatore riceve automaticamente 10% delle shares (1,000 su 10,000) 
                    alla creazione del progetto. Il restante 90% viene distribuito dinamicamente a chi completa task e investe.
                </p>
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessun holder registrato ancora.</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Revenue History -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-6 py-4">
            <h2 class="text-2xl font-bold text-white">Revenue</h2>
            <p class="text-purple-100 text-sm mt-1">Storico revenue generato dal progetto</p>
        </div>

        <div class="p-6">
            {% if transparency_data.revenue.history %}
            <div class="space-y-3">
                {% for rev in transparency_data.revenue.history[:20] %}
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="material-icons text-purple-600">euro</span>
                            <div>
                                <div class="font-semibold text-gray-900">€{{ "%.2f"|format(rev.amount) }} {{ rev.currency }}</div>
                                <div class="text-sm text-gray-500">
                                    {{ rev.source or 'N/A' }}
                                    {% if rev.description %}
                                        - {{ rev.description[:50] }}{% if rev.description|length > 50 %}...{% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        {% if rev.recorded_at %}
                            {{ rev.recorded_at[:10] }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessun revenue registrato ancora.</p>
            {% endif %}
        </div>
    </div>

    <!-- Distributions History -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-6 py-4">
            <h2 class="text-2xl font-bold text-white">Distribuzioni</h2>
            <p class="text-orange-100 text-sm mt-1">Storico distribuzioni ai partecipanti</p>
        </div>

        <div class="p-6">
            {% if transparency_data.distributions.history %}
            <div class="space-y-3">
                {% for dist in transparency_data.distributions.history[:20] %}
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                    <div class="flex-1">
                        <div class="flex items-center gap-3">
                            <span class="material-icons text-orange-600">payments</span>
                            <div>
                                <div class="font-semibold text-gray-900">
                                    €{{ "%.2f"|format(dist.amount) }} {{ dist.currency }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {% if dist.get('is_anonymous') or not dist.get('user_id') %}
                                        <span>{{ dist.username }}</span>
                                    {% else %}
                                        <a href="{{ url_for('users.user_profile', username=dist.username) }}" 
                                           class="text-blue-600 hover:text-blue-800">
                                            {{ dist.username }}
                                        </a>
                                    {% endif %}
                                    - {{ "%.2f"|format(dist.shares_count) }} shares ({{ "%.2f"|format(dist.percentage) }}%)
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        {% if dist.distributed_at %}
                            {{ dist.distributed_at[:10] }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-8">Nessuna distribuzione registrata ancora.</p>
            {% endif %}
        </div>
    </div>

    <!-- Monthly Reports -->
    {% if monthly_reports %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-indigo-500 to-indigo-600 px-6 py-4">
            <h2 class="text-2xl font-bold text-white">Report Mensili</h2>
            <p class="text-indigo-100 text-sm mt-1">Report automatici di trasparenza</p>
        </div>

        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for report in monthly_reports %}
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-900">
                            {{ report.report_year }}-{{ "%02d"|format(report.report_month) }}
                        </h3>
                        {% if report.generated_by_system %}
                            <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Auto</span>
                        {% endif %}
                    </div>
                    <div class="space-y-1 text-sm text-gray-600">
                        <div>Revenue: €{{ "%.2f"|format(report.total_revenue or 0) }}</div>
                        <div>Distribuzioni: €{{ "%.2f"|format(report.total_distributions or 0) }}</div>
                        <div>Nuovi holders: {{ report.new_holders_count or 0 }}</div>
                    </div>
                    <div class="mt-3 text-xs text-gray-400">
                        Generato: {{ report.generated_at.strftime('%d/%m/%Y') if report.generated_at else 'N/A' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                <span class="material-icons text-sm mr-2">arrow_back</span>
                Torna al Progetto
            </a>

            <div class="flex gap-2">
                <a href="{{ url_for('projects.export_transparency', project_id=project.id, format='json') }}" 
                   class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">
                    <span class="material-icons text-sm mr-2">download</span>
                    JSON
                </a>
                <a href="{{ url_for('projects.export_transparency', project_id=project.id, format='csv') }}" 
                   class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                    <span class="material-icons text-sm mr-2">file_download</span>
                    CSV
                </a>
                <a href="{{ url_for('projects.api_project_transparency', project_id=project.id) }}" 
                   target="_blank"
                   class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">
                    <span class="material-icons text-sm mr-2">api</span>
                    API
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

