<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Creazione Progetto in Corso...</title>
    <style>
        /* Stile per lo spinner */
        .spinner-container { display: flex; justify-content: center; align-items: center; height: 70vh; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('projects.home') }}">CollabForge</a>
        </div>
    </nav>

    <div class="container">
        <h1>Elaborazione in corso...</h1>
        <p class="lead">L'intelligenza artificiale sta analizzando il tuo pitch e generando i primi task per il progetto.</p>
        <hr>

        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <strong class="ms-3">Attendere prego...</strong>
        </div>

        <div id="error-message" class="alert alert-danger mt-4" style="display: none;">
            Si è verificato un errore durante la creazione del progetto. Riprova.
        </div>

        <input type="hidden" id="project-pitch" value="{{ pitch }}">

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pitchInput = document.getElementById('project-pitch');
            const errorMessageDiv = document.getElementById('error-message');

            if (!pitchInput || !pitchInput.value) {
                console.error("Pitch non trovato nella pagina.");
                errorMessageDiv.textContent = "Errore: Pitch non trovato per l'invio.";
                errorMessageDiv.style.display = 'block';
                return;
            }

            const pitchValue = pitchInput.value;
            // Usa il prefisso corretto per l'endpoint API
            const apiUrl = "{{ url_for('api.create_project_api') }}";

            console.log("Invio pitch all'API:", apiUrl);

            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Aggiungi altri header se necessari (es. autenticazione)
                },
                body: JSON.stringify({ pitch: pitchValue })
            })
            .then(response => {
                if (!response.ok) {
                    // Se la risposta non è 2xx, leggi l'errore JSON se possibile
                    return response.json().then(errData => {
                        throw new Error(errData.error || `Errore ${response.status}`);
                    }).catch(() => {
                        // Se non c'è corpo JSON o non è JSON valido
                        throw new Error(`Errore HTTP ${response.status}`);
                    });
                }
                return response.json(); // Parse JSON della risposta di successo (201)
            })
            .then(data => {
                console.log("Progetto creato:", data);
                if (data.project && data.project.id) {
                    // Reindirizza alla pagina del nuovo progetto
                    const projectUrl = "{{ url_for('projects.project_detail', project_id=0) }}".replace('0', data.project.id);
                    window.location.href = projectUrl;
                } else {
                    throw new Error("Risposta API non valida dopo la creazione.");
                }
            })
            .catch(error => {
                console.error('Errore durante la chiamata API:', error);
                errorMessageDiv.textContent = `Errore creazione progetto: ${error.message}. Riprova o contatta supporto.`;
                errorMessageDiv.style.display = 'block';
                // Nascondi lo spinner
                const spinnerContainer = document.querySelector('.spinner-container');
                if(spinnerContainer) spinnerContainer.style.display = 'none';
            });
        });
    </script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>