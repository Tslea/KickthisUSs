{% extends "base.html" %}

{% block title %}Proposte Libere - KickThisUss{% endblock %}

{% block content %}
<main class="bg-black min-h-screen text-white py-8 md:py-12">
    <div class="max-w-7xl mx-auto px-6">
        
        {# Header #}
        <div class="mb-8 md:mb-12">
            <h1 class="text-5xl md:text-7xl font-bold font-display mb-4">Proposte Libere</h1>
            <p class="text-xl text-gray-500 max-w-2xl">
                Gestisci le proposte che hai inviato e quelle ricevute per i tuoi progetti
            </p>
        </div>

        {# Stats Cards #}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-500 mb-2">Proposte Inviate</div>
                <div class="text-3xl font-bold text-white font-display">{{ submitted_proposals | length }}</div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-500 mb-2">Proposte Ricevute</div>
                <div class="text-3xl font-bold text-white font-display">{{ received_proposals | length }}</div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-6">
                <div class="text-sm text-gray-500 mb-2">In Attesa</div>
                <div class="text-3xl font-bold text-white font-display">
                    {{ received_proposals | selectattr('status', 'equalto', 'pending') | list | length }}
                </div>
            </div>
        </div>

        {# Tabs #}
        <div class="mb-8">
            <div class="flex gap-4 border-b border-gray-800">
                <button onclick="switchTab('submitted')" id="tab-submitted" 
                        class="px-6 py-3 border-b-2 border-white text-white font-bold transition-colors">
                    Inviate
                    {% if submitted_proposals %}<span class="ml-2 text-gray-500">({{ submitted_proposals | length }})</span>{% endif %}
                </button>
                <button onclick="switchTab('received')" id="tab-received" 
                        class="px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-white font-bold transition-colors">
                    Ricevute
                    {% if received_proposals %}<span class="ml-2 text-gray-500">({{ received_proposals | length }})</span>{% endif %}
                </button>
            </div>
        </div>

        {# Submitted Proposals #}
        <div id="panel-submitted" class="tab-panel">
            {% if submitted_proposals %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for proposal in submitted_proposals %}
                <div class="bg-gray-900 border border-gray-800 rounded-xl p-6 hover:border-gray-700 transition-colors">
                    <div class="flex items-start justify-between mb-4">
                        <span class="px-3 py-1 bg-gray-800 border border-gray-700 rounded-full text-xs font-bold text-gray-400 uppercase">
                            {% if proposal.status == 'pending' %}In Attesa
                            {% elif proposal.status == 'accepted' %}Accettata
                            {% else %}Rifiutata{% endif %}
                        </span>
                        <span class="px-3 py-1 bg-blue-900/30 border border-blue-800 rounded-full text-xs font-bold text-blue-400">
                            {{ proposal.equity_requested }}% equity
                        </span>
                    </div>
                    
                    <h3 class="text-lg font-bold text-white mb-2 font-display">
                        <a href="{{ url_for('free_proposals.view_free_proposal', proposal_id=proposal.id) }}" 
                           class="hover:text-accent transition-colors">
                            {{ proposal.title }}
                        </a>
                    </h3>
                    
                    <p class="text-gray-500 text-sm mb-4 line-clamp-2">
                        {{ proposal.description[:120] }}{% if proposal.description|length > 120 %}...{% endif %}
                    </p>
                    
                    <div class="space-y-2 mb-4 text-xs text-gray-600">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-sm">folder</span>
                            <a href="{{ url_for('projects.project_detail', project_id=proposal.project.id) }}" 
                               class="hover:text-white transition-colors">
                                {{ proposal.project.name }}
                            </a>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-sm">calendar_today</span>
                            {{ proposal.created_at.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    
                    <a href="{{ url_for('free_proposals.view_free_proposal', proposal_id=proposal.id) }}" 
                       class="block w-full text-center px-4 py-2 bg-gray-800 border border-gray-700 text-white rounded-lg hover:bg-gray-700 transition-colors text-sm font-bold">
                        Vedi Dettagli
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-12 text-center">
                <span class="material-icons text-6xl text-gray-700 mb-4">inbox</span>
                <h3 class="text-xl font-bold text-white mb-2">Nessuna proposta inviata</h3>
                <p class="text-gray-500 mb-6">Trova un progetto e condividi la tua idea</p>
                <a href="{{ url_for('projects.home') }}" 
                   class="inline-block px-6 py-3 bg-accent text-white font-bold rounded-lg hover:bg-red-600 transition-colors">
                    Esplora Progetti
                </a>
            </div>
            {% endif %}
        </div>

        {# Received Proposals #}
        <div id="panel-received" class="tab-panel hidden">
            {% if received_proposals %}
            {# Filters #}
            <div class="flex gap-2 mb-6 flex-wrap">
                <button onclick="filterProposals('all')" data-filter="all" 
                        class="px-4 py-2 bg-gray-900 border border-gray-800 text-white rounded-lg hover:bg-gray-800 transition-colors text-sm font-bold filter-btn active">
                    Tutte ({{ received_proposals | length }})
                </button>
                <button onclick="filterProposals('pending')" data-filter="pending" 
                        class="px-4 py-2 bg-gray-900 border border-gray-800 text-gray-500 rounded-lg hover:bg-gray-800 hover:text-white transition-colors text-sm font-bold filter-btn">
                    In Attesa ({{ received_proposals | selectattr('status', 'equalto', 'pending') | list | length }})
                </button>
                <button onclick="filterProposals('accepted')" data-filter="accepted" 
                        class="px-4 py-2 bg-gray-900 border border-gray-800 text-gray-500 rounded-lg hover:bg-gray-800 hover:text-white transition-colors text-sm font-bold filter-btn">
                    Accettate ({{ received_proposals | selectattr('status', 'equalto', 'accepted') | list | length }})
                </button>
                <button onclick="filterProposals('rejected')" data-filter="rejected" 
                        class="px-4 py-2 bg-gray-900 border border-gray-800 text-gray-500 rounded-lg hover:bg-gray-800 hover:text-white transition-colors text-sm font-bold filter-btn">
                    Rifiutate ({{ received_proposals | selectattr('status', 'equalto', 'rejected') | list | length }})
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="proposals-grid">
                {% for proposal in received_proposals %}
                <div class="proposal-card bg-gray-900 border border-gray-800 rounded-xl p-6 hover:border-gray-700 transition-colors" 
                     data-status="{{ proposal.status }}">
                    <div class="flex items-start justify-between mb-4">
                        <span class="px-3 py-1 bg-gray-800 border border-gray-700 rounded-full text-xs font-bold text-gray-400 uppercase status-badge">
                            {% if proposal.status == 'pending' %}In Attesa
                            {% elif proposal.status == 'accepted' %}Accettata
                            {% else %}Rifiutata{% endif %}
                        </span>
                        <span class="px-3 py-1 bg-blue-900/30 border border-blue-800 rounded-full text-xs font-bold text-blue-400">
                            {{ proposal.equity_requested }}% equity
                        </span>
                    </div>
                    
                    <h3 class="text-lg font-bold text-white mb-2 font-display">
                        <a href="{{ url_for('free_proposals.view_free_proposal', proposal_id=proposal.id) }}" 
                           class="hover:text-accent transition-colors">
                            {{ proposal.title }}
                        </a>
                    </h3>
                    
                    <p class="text-gray-500 text-sm mb-4 line-clamp-2">
                        {{ proposal.description[:120] }}{% if proposal.description|length > 120 %}...{% endif %}
                    </p>
                    
                    <div class="space-y-2 mb-4 text-xs text-gray-600">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-sm">person</span>
                            {{ proposal.developer.username }}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-sm">folder</span>
                            <a href="{{ url_for('projects.project_detail', project_id=proposal.project.id) }}" 
                               class="hover:text-white transition-colors">
                                {{ proposal.project.name }}
                            </a>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-sm">calendar_today</span>
                            {{ proposal.created_at.strftime('%d/%m/%Y') }}
                        </div>
                    </div>
                    
                    <a href="{{ url_for('free_proposals.view_free_proposal', proposal_id=proposal.id) }}" 
                       class="block w-full text-center px-4 py-2 {% if proposal.status == 'pending' %}bg-accent hover:bg-red-600{% else %}bg-gray-800 border border-gray-700 hover:bg-gray-700{% endif %} text-white rounded-lg transition-colors text-sm font-bold">
                        {% if proposal.status == 'pending' %}
                        Valuta Proposta
                        {% else %}
                        Vedi Dettagli
                        {% endif %}
                    </a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-900 border border-gray-800 rounded-xl p-12 text-center">
                <span class="material-icons text-6xl text-gray-700 mb-4">notifications_none</span>
                <h3 class="text-xl font-bold text-white mb-2">Nessuna proposta ricevuta</h3>
                <p class="text-gray-500">Quando altri creator proporranno soluzioni ai tuoi progetti le vedrai qui</p>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<script>
let currentFilter = 'all';

function switchTab(tab) {
    document.getElementById('panel-submitted').classList.toggle('hidden', tab !== 'submitted');
    document.getElementById('panel-received').classList.toggle('hidden', tab !== 'received');
    
    document.getElementById('tab-submitted').classList.toggle('border-white', tab === 'submitted');
    document.getElementById('tab-submitted').classList.toggle('text-white', tab === 'submitted');
    document.getElementById('tab-submitted').classList.toggle('border-transparent', tab !== 'submitted');
    document.getElementById('tab-submitted').classList.toggle('text-gray-500', tab !== 'submitted');
    
    document.getElementById('tab-received').classList.toggle('border-white', tab === 'received');
    document.getElementById('tab-received').classList.toggle('text-white', tab === 'received');
    document.getElementById('tab-received').classList.toggle('border-transparent', tab !== 'received');
    document.getElementById('tab-received').classList.toggle('text-gray-500', tab !== 'received');
}

function filterProposals(status) {
    currentFilter = status;
    const cards = document.querySelectorAll('.proposal-card');
    const buttons = document.querySelectorAll('.filter-btn');
    
    buttons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === status);
        btn.classList.toggle('text-white', btn.dataset.filter === status);
        btn.classList.toggle('text-gray-500', btn.dataset.filter !== status);
    });
    
    cards.forEach(card => {
        if (status === 'all' || card.dataset.status === status) {
            card.classList.remove('hidden');
        } else {
            card.classList.add('hidden');
        }
    });
}

// Initialize from URL params
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const view = params.get('view');
    if (view === 'received') {
        switchTab('received');
    }
});
</script>
{% endblock %}
